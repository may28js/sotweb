# 🚀 网站更新与部署操作指南 (SOP)

## 第一阶段：本地开发与提交 (Local)

在您的本地电脑（Windows）上完成代码修改后，需要将其同步到 GitHub 仓库。

### 1. 提交代码 (Commit)
如果您使用命令行：
```powershell
# 添加所有修改
git add .

# 提交并写明备注
git commit -m "描述您的修改内容，例如：优化社区页面UI，修复构建错误"
```

### 2. 推送到 GitHub (Push)
由于 GitHub 安全策略限制，推荐使用 **GitHub Desktop** 进行推送，或者配置好 SSH/Token 后使用命令行。

*   **命令行方式**：
    ```powershell
    git push
    ```
*   **GitHub Desktop 方式**：
    1.  打开 GitHub Desktop。
    2.  点击顶部工具栏的 **"Push origin"** 按钮。

---

## 第二阶段：服务器端部署 (VPS)

通过 SSH 登录您的 VPS 服务器，执行以下操作。

### 1. 进入项目目录
```bash
cd /root/sotweb
```

### 2. 同步最新代码 (Git Pull)
从 GitHub 拉取最新的修改。

**常规情况：**
```bash
git pull
```

**⚠️ 特殊情况处理：如果有冲突**
如果提示 "local changes would be overwritten"，说明服务器上有未提交的手动修改。如果这些修改不再需要，强制覆盖它们：
```bash
# 慎用：这将丢弃服务器上所有未提交的修改，使其与远程仓库完全一致
git reset --hard
git pull
```

### 3. 清理磁盘空间 (预防性措施)
构建过程需要较大空间。为了防止 "No space left on device" 错误，建议在构建前清理旧的 Docker 缓存。

```bash
# 删除停止的容器、未使用的镜像和构建缓存
docker system prune -a -f
```
*(如果空间依然不足，可以使用 `df -h` 检查磁盘，或手动查找大文件)*

### 4. 构建并启动服务 (Build & Deploy)
这是最关键的一步，Docker 会根据最新的代码重新打包镜像并启动容器。

```bash
# --build: 强制重新构建镜像
# -d: 后台运行模式
docker-compose up --build -d
```

---

## 第三阶段：验证与监控

### 1. 检查运行日志
部署命令完成后，建议查看日志以确保没有报错（如数据库连接失败、API 报错等）。

```bash
# 查看所有服务的实时日志 (按 Ctrl+C 退出)
docker-compose logs -f --tail=100

# 或者只查看后端的日志
docker-compose logs -f server
```

### 2. 浏览器验证
访问您的网站域名，检查更新内容是否生效：
*   **UI 检查**：页面布局高度是否正常？链接是否正确？
*   **功能检查**：登录、修改密码、邮件验证码等功能是否可用？

---

## 🔧 常见故障排除 (Troubleshooting)

| 错误信息 (关键词) | 原因 | 解决方案 |
| :--- | :--- | :--- |
| `Authentication failed` (Git Push时) | GitHub 密码验证失效 | 使用 GitHub Desktop 推送，或配置 Personal Access Token。 |
| `Your local changes... overwritten by merge` | 服务器上有手动修改的文件 | 执行 `git reset --hard` 丢弃本地修改，然后 `git pull`。 |
| `no space left on device` | 磁盘空间不足 | 执行 `docker system prune -a -f` 清理 Docker 垃圾。 |
| `Type error` / `Failed to compile` | 代码有语法或类型错误 | 在本地修复错误（如 TypeScript 类型定义），提交并推送后，再次在服务器拉取构建。 |
| `Connection was reset` (Git时) | 网络连接不稳定 | 多重试几次，或检查服务器网络设置。 |
