'use client'

import Link from 'next/link'
import Image from 'next/image'
import { useState, useEffect, useRef } from 'react'
import { usePathname } from 'next/navigation'
import { Menu, X, ChevronDown, ShoppingCart, Gem, History, LayoutDashboard, Wrench, Map, LogOut, User as UserIcon } from 'lucide-react'

export default function Navbar() {
  const [isOpen, setIsOpen] = useState(false)
  const [isLoggedIn, setIsLoggedIn] = useState(true)
  const [isUserMenuOpen, setIsUserMenuOpen] = useState(false)
  // 新增：滚动状态
  const [isScrolled, setIsScrolled] = useState(false)
  const pathname = usePathname()
  
  const userMenuRef = useRef(null)

  // 新增：监听滚动事件
  useEffect(() => {
    const handleScroll = () => {
      // 当滚动超过 20px 时切换状态
      setIsScrolled(window.scrollY > 20)
    }
    
    // 初始化检查
    handleScroll()
    
    window.addEventListener('scroll', handleScroll)
    return () => {
      window.removeEventListener('scroll', handleScroll)
    }
  }, [])

  // Handle click outside to close user menu
  useEffect(() => {
    function handleClickOutside(event) {
      if (userMenuRef.current && !userMenuRef.current.contains(event.target)) {
        setIsUserMenuOpen(false)
      }
    }
    document.addEventListener("mousedown", handleClickOutside)
    return () => {
      document.removeEventListener("mousedown", handleClickOutside)
    }
  }, [])

  // Helper to get link classes based on active state
  const getLinkClass = (path) => {
    const isActive = pathname === path;
    const base = "px-6 h-full flex items-center transition-colors relative group";
    
    if (isActive) {
      return `${base} text-white border-b-2 border-[#c69c6d] bg-white/5 cursor-default`;
    }
    return `${base} text-gray-300 hover:text-white hover:bg-white/5 cursor-pointer`;
  }

  // Common Dropdown Item Style
  const dropdownItemClass = "block px-3 py-2 mx-1.5 my-1 rounded-md text-xs text-gray-300 hover:bg-white/10 hover:text-white cursor-pointer flex items-center transition-colors";
  const dropdownItemClassHighlight = "block px-3 py-2 mx-1.5 my-1 rounded-md text-xs text-yellow-500 hover:bg-white/10 hover:text-yellow-400 cursor-pointer flex items-center transition-colors";
  const dropdownItemClassRed = "text-left px-3 py-2 mx-1.5 my-1 rounded-md text-xs text-red-400 hover:bg-white/10 hover:text-red-300 cursor-pointer flex items-center transition-colors";

  return (
    // 修改：根据 isScrolled 动态调整 padding，添加 transition
    <nav className={`fixed w-full z-50 top-0 flex justify-center pointer-events-none transition-all duration-300 ease-in-out ${isScrolled ? 'pt-0 px-0' : 'pt-6 px-4'}`}>
      {/* 修改：根据 isScrolled 动态调整宽度和圆角，添加 transition */}
      <div className={`bg-[#181818] pointer-events-auto backdrop-blur-md shadow-2xl h-16 flex items-center justify-between px-8 transition-all duration-300 ease-in-out ${isScrolled ? 'w-full max-w-[1280px] rounded-b-md rounded-t-none' : 'w-full max-w-[1280px] rounded-md'}`}>
          
          {/* Left Side: Logo + Navigation */}
          <div className="flex items-center h-full">
            
            {/* Logo Area - Image Only - 64x64 Square */}
            <Link href="/" className="flex items-center justify-center w-16 h-full bg-[#181818] hover:bg-[#222] transition-colors border-r border-white/5 relative group cursor-pointer">
               <div className="relative w-8 h-8 transform group-hover:scale-110 transition-transform duration-300">
                 <Image 
                   src="/demo-assets/home/mark.svg" 
                   alt="Logo" 
                   fill
                   className="object-contain drop-shadow-[0_0_5px_rgba(198,156,109,0.3)]"
                 />
              </div>
            </Link>

            {/* Desktop Navigation */}
            <div className="hidden lg:flex items-center h-full">
              
              <Link href="/" className={getLinkClass('/')}>
                <span className="text-xs font-serif font-bold tracking-widest">HOME</span>
              </Link>

              <Link href="/news" className={getLinkClass('/news')}>
                <span className="text-xs font-serif font-bold tracking-widest">NEWS</span>
              </Link>

              <Link href="/about" className={getLinkClass('/about')}>
                <span className="text-xs font-serif font-bold tracking-widest">ABOUT</span>
              </Link>

              <Link href="/faq" className={getLinkClass('/faq')}>
                <span className="text-xs font-serif font-bold tracking-widest">FAQ</span>
              </Link>

              {/* Shop Dropdown */}
              <div className="group relative h-full flex items-center">
                <button className="px-6 h-full flex items-center text-gray-300 hover:bg-white/5 hover:text-white transition-colors group-hover:text-white cursor-pointer">
                  <span className="text-xs font-serif font-bold tracking-widest">SHOP</span>
                  <ChevronDown className="ml-1 w-3 h-3 opacity-60" />
                </button>
                {/* Dropdown Container with Padding for Bridge */}
                <div className="absolute left-1/2 -translate-x-1/2 top-full pt-3 w-56 z-50 invisible opacity-0 -translate-y-2 group-hover:visible group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-300 ease-in-out">
                  <div className="relative bg-[#1e1e1e] border border-white/10 shadow-xl py-1 rounded-md">
                     {/* Bubble Arrow */}
                     <div className="absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-[#1e1e1e] border-t border-l border-white/10 rotate-45"></div>
                     
                     <Link href="/shop" className={dropdownItemClass}>
                       <ShoppingCart className="w-4 h-4 mr-2" /> Browse Items
                     </Link>
                     <Link href="/shop/donate" className={dropdownItemClass}>
                       <Gem className="w-4 h-4 mr-2 text-yellow-500" /> Premium Crystals
                     </Link>
                     <Link href="/shop/history" className={dropdownItemClass}>
                       <History className="w-4 h-4 mr-2 opacity-70" /> Purchase History
                     </Link>
                  </div>
                </div>
              </div>

              <Link href="/play" className={getLinkClass('/play')}>
                <span className="text-xs font-serif font-bold tracking-widest text-[#c69c6d]">PLAY</span>
              </Link>
              
              <Link href="/discord" className={getLinkClass('/discord')}>
                <span className="text-xs font-serif font-bold tracking-widest">DISCORD</span>
              </Link>

              <Link href="/vote" className={getLinkClass('/vote')}>
                <span className="text-xs font-serif font-bold tracking-widest">VOTE</span>
              </Link>

            </div>
          </div>

          {/* Right Side: Auth / User */}
          <div className="flex items-center h-full">
               
               {isLoggedIn ? (
                 <>
                   {/* User Profile Dropdown */}
                   <div className="relative h-full flex items-center ml-4" ref={userMenuRef}>
                        <button 
                          onClick={() => setIsUserMenuOpen(!isUserMenuOpen)}
                          className="flex items-center space-x-3 text-gray-300 hover:text-white transition-colors cursor-pointer"
                        >
                          <div className="relative w-8 h-8 rounded bg-white/10 overflow-hidden border border-white/10">
                            <Image 
                              src="/demo-assets/user/avatar-placeholder.jpg" 
                              alt="User" 
                              fill
                              className="object-cover"
                            />
                          </div>
                          <div className="hidden xl:block text-left">
                            <p className="text-xs font-bold text-white leading-tight">demo user</p>
                            <p className="text-[10px] text-yellow-500 leading-tight">0 VP • 0 DP</p>
                          </div>
                          <ChevronDown className={`w-3 h-3 transition-transform duration-200 ${isUserMenuOpen ? 'rotate-180' : ''}`} />
                        </button>

                        {/* Dropdown Menu */}
                        <div className={`absolute right-0 top-full pt-3 w-64 z-50 transition-all duration-200 ${isUserMenuOpen ? 'visible opacity-100 translate-y-0' : 'invisible opacity-0 -translate-y-2'}`}>
                            <div className="relative bg-[#1e1e1e] border border-white/10 shadow-xl rounded-md overflow-hidden">
                               {/* Bubble Arrow */}
                               <div className="absolute -top-1.5 right-6 w-3 h-3 bg-[#1e1e1e] border-t border-l border-white/10 rotate-45"></div>
                               
                               {/* Header */}
                               <div className="px-4 py-3 border-b border-white/5">
                                  <p className="text-sm font-bold text-white">demo user</p>
                                  <p className="text-xs text-gray-500 mt-0.5">demo@example.com</p>
                               </div>

                               {/* Section 1: Dashboard Tools */}
                               <div className="py-1 border-b border-white/5">
                                 <Link href="/dashboard" className={dropdownItemClass}>
                                    <UserIcon className="w-3.5 h-3.5 mr-2.5 opacity-70" /> User Dashboard     
                                 </Link>
                                 <Link href="/dashboard/unstuck" className={dropdownItemClass}>
                                    <Wrench className="w-3.5 h-3.5 mr-2.5 opacity-70" /> Unstuck Character    
                                 </Link>
                                 <Link href="/dashboard/teleport" className={dropdownItemClass}>
                                    <Map className="w-3.5 h-3.5 mr-2.5 opacity-70" /> Teleport Character      
                                 </Link>
                               </div>

                               {/* Section 2: Shop & History */}
                               <div className="py-1 border-b border-white/5">
                                 <Link href="/shop/donate" className={dropdownItemClassHighlight}>
                                    <Gem className="w-3.5 h-3.5 mr-2.5" /> Premium Crystals
                                 </Link>
                                 <Link href="/shop" className={dropdownItemClass}>
                                    <ShoppingCart className="w-3.5 h-3.5 mr-2.5 opacity-70" /> Browse Items   
                                 </Link>
                                 <Link href="/shop/history" className={dropdownItemClass}>
                                    <History className="w-3.5 h-3.5 mr-2.5 opacity-70" /> Purchase History    
                                 </Link>
                               </div>

                               {/* Section 3: Logout */}
                               <div className="py-1">
                                 <div className={dropdownItemClassRed}>
                                    <LogOut className="w-3.5 h-3.5 mr-2.5" /> Logout
                                 </div>
                               </div>
                            </div>
                        </div>
                   </div>
                 </>
               ) : (
                 <Link href="/login" className="text-xs font-bold text-white hover:text-[#c69c6d] transition-colors cursor-pointer">LOGIN</Link>
               )}

               {/* Mobile Menu Button */}
               <div className="lg:hidden ml-4">
                <button
                  onClick={() => setIsOpen(!isOpen)}
                  className="text-gray-300 hover:text-white p-1 cursor-pointer"
                >
                  {isOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
                </button>
              </div>
          </div>
      </div>

      {/* Mobile Menu Overlay */}
      {isOpen && (
        <div className="absolute top-20 left-4 right-4 bg-[#1e1e1e] border border-white/10 shadow-2xl rounded-md z-40 lg:hidden pointer-events-auto">
          <div className="px-2 pt-2 pb-3 space-y-1">
            <Link href="/" className="block px-3 py-2 text-sm font-medium text-white hover:bg-white/10 rounded-md cursor-pointer">HOME</Link>
            <Link href="/news" className="block px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 rounded-md cursor-pointer">NEWS</Link>
            <Link href="/about" className="block px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 rounded-md cursor-pointer">ABOUT</Link>
            <Link href="/faq" className="block px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 rounded-md cursor-pointer">FAQ</Link>
            <Link href="/shop" className="block px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 rounded-md cursor-pointer">SHOP</Link>
            <Link href="/play" className="block px-3 py-2 text-sm font-medium text-[#c69c6d] hover:bg-[#c69c6d]/10 rounded-md cursor-pointer">PLAY</Link>
            <Link href="/discord" className="block px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 rounded-md cursor-pointer">DISCORD</Link>
            <Link href="/vote" className="block px-3 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-white/10 rounded-md cursor-pointer">VOTE</Link>
          </div>
        </div>
      )}
    </nav>
  )
}